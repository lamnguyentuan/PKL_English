{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1 text-primary"><i class="fas fa-book-open me-2"></i>Chủ đề Từ vựng</h2>
            <p class="text-muted">Chọn một chủ đề để bắt đầu học Flashcard</p>
        </div>
        <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="loadTopics()">
            <i class="fas fa-sync-alt me-1"></i> Làm mới
        </button>
    </div>

    <div id="study-topic-list" class="row">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Đang tải danh sách chủ đề...</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadTopics();
    });

    function loadTopics() {
        const container = document.getElementById('study-topic-list');
        
        // GỌI API (Đường dẫn chuẩn: /api/topics/)
        fetch('/api/topics/')
            .then(response => {
                if (!response.ok) {
                    throw new Error("Lỗi kết nối Server (" + response.status + ")");
                }
                return response.json();
            })
            .then(data => {
                container.innerHTML = ''; // Xóa icon loading

                // Trường hợp chưa có dữ liệu
                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center text-muted py-5">
                            <i class="fas fa-folder-open fa-3x mb-3"></i>
                            <p>Chưa có chủ đề nào.</p>
                        </div>`;
                    return;
                }

                // Duyệt qua từng chủ đề và tạo thẻ HTML
                data.forEach(topic => {
                    // Xử lý ảnh (Dùng ảnh mặc định nếu không có)
                    const imageUrl = topic.image ? topic.image : 'https://via.placeholder.com/600x400?text=No+Image';
                    
                    // Xử lý mô tả
                    const description = topic.description ? topic.description : 'Không có mô tả.';

                    // Xử lý tiến độ (Progress)
                    const progress = topic.progress || 0;
                    
                    // Render HTML Card
                    const html = `
                    <div class="col-md-4 mb-4 animate__animated animate__fadeIn">
                        <div class="card h-100 shadow-sm border-0 hover-lift">
                            <div class="position-relative">
                                <img src="${imageUrl}" class="card-img-top" alt="${topic.title}" 
                                     style="height: 200px; object-fit: cover;">
                                
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-dark bg-opacity-75 rounded-pill">
                                        ${topic.vocabulary_count || 0} từ
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold text-dark">${topic.title}</h5>
                                <p class="card-text text-muted flex-grow-1 small">
                                    ${description}
                                </p>
                                
                                <div class="mt-3 mb-3">
                                    <div class="d-flex justify-content-between small text-muted mb-1">
                                        <span>Tiến độ</span>
                                        <span>${progress}%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>

                                <a href="/study/flashcards/${topic.id}/" class="btn btn-primary w-100 rounded-pill fw-bold">
                                    Học ngay <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = `
                    <div class="col-12 text-center text-danger py-5">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Không thể tải danh sách chủ đề.</p>
                        <small class="text-muted">${error.message}</small>
                        <div class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="loadTopics()">Thử lại</button>
                        </div>
                    </div>`;
            });
    }
</script>

<style>
    /* Hiệu ứng nhấc thẻ khi di chuột vào */
    .hover-lift {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
</style>
{% endblock %}