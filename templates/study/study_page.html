{% extends "base.html" %} {% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <!-- Header với loại câu hỏi -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <span class="badge bg-primary fs-6">
            {% if question.type == 'listening' %}
            <i class="fas fa-headphones me-1"></i> Nghe và viết {% else %}
            <i class="fas fa-pen me-1"></i> Điền từ {% endif %}
          </span>
          <a
            href="{% url 'topic_list' %}"
            class="btn btn-outline-secondary btn-sm"
          >
            <i class="fas fa-arrow-left me-1"></i> Quay lại
          </a>
        </div>

        <!-- Hình ảnh minh họa (nếu có) -->
        {% if question.image %}
        <div class="text-center mb-4">
          <img
            src="{{ question.image }}"
            class="img-fluid rounded"
            style="max-height: 200px; object-fit: cover"
          />
        </div>
        {% endif %}

        <!-- Audio player (nếu là câu hỏi nghe) -->
        {% if question.type == 'listening' and question.audio %}
        <div class="text-center mb-4">
          <button
            type="button"
            class="btn btn-lg btn-outline-primary rounded-circle"
            id="playAudioBtn"
            style="width: 80px; height: 80px"
          >
            <i class="fas fa-volume-up fa-2x"></i>
          </button>
          <audio id="questionAudio" src="{{ question.audio }}"></audio>
          <p class="text-muted mt-2">Nhấn để nghe</p>
        </div>
        {% endif %}

        <!-- Hướng dẫn -->
        <div class="alert alert-light border mb-4">
          <i class="fas fa-lightbulb text-warning me-2"></i>
          {{ question.instruction }}
        </div>

        <!-- Câu có chỗ trống (nếu là fill_blank) -->
        {% if question.sentence %}
        <div class="text-center mb-4">
          <p class="fs-4 fw-light" id="sentenceDisplay">
            {{ question.sentence }}
          </p>
        </div>
        {% endif %}

        <!-- Gợi ý độ dài từ -->
        <div class="text-center text-muted mb-3">
          <small
            >Gợi ý: Từ có <strong>{{ question.word_length }}</strong> ký
            tự</small
          >
        </div>

        <!-- Form nhập câu trả lời -->
        <form id="answerForm">
          <input type="hidden" id="cardId" value="{{ question.card_id }}" />
          <input type="hidden" id="topicId" value="{{ topic_id }}" />

          <div class="mb-3">
            <input
              type="text"
              class="form-control form-control-lg text-center"
              id="answerInput"
              placeholder="Nhập câu trả lời của bạn..."
              autocomplete="off"
              autofocus
            />
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
              <i class="fas fa-check me-2"></i> Kiểm tra
            </button>
          </div>
        </form>

        <!-- Kết quả (ẩn ban đầu) -->
        <div id="resultSection" class="mt-4" style="display: none">
          <div id="resultAlert" class="alert text-center">
            <h4 id="resultTitle"></h4>
            <p id="resultMessage"></p>
          </div>
          <div class="d-grid">
            <button
              type="button"
              class="btn btn-outline-primary btn-lg"
              id="nextBtn"
            >
              <i class="fas fa-arrow-right me-2"></i> Câu tiếp theo
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("answerForm");
    const answerInput = document.getElementById("answerInput");
    const submitBtn = document.getElementById("submitBtn");
    const resultSection = document.getElementById("resultSection");
    const resultAlert = document.getElementById("resultAlert");
    const resultTitle = document.getElementById("resultTitle");
    const resultMessage = document.getElementById("resultMessage");
    const nextBtn = document.getElementById("nextBtn");
    const playAudioBtn = document.getElementById("playAudioBtn");
    const questionAudio = document.getElementById("questionAudio");

    // Play audio button
    if (playAudioBtn && questionAudio) {
      playAudioBtn.addEventListener("click", function () {
        questionAudio.play();
      });
    }

    // Submit answer
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const cardId = document.getElementById("cardId").value;
      const answer = answerInput.value.trim();

      if (!answer) {
        answerInput.classList.add("is-invalid");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin me-2"></i> Đang kiểm tra...';

      fetch('{% url "submit_answer" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
          card_id: cardId,
          answer: answer,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          form.style.display = "none";
          resultSection.style.display = "block";

          if (data.is_correct) {
            resultAlert.className = "alert alert-success text-center";
            resultTitle.innerHTML =
              '<i class="fas fa-check-circle me-2"></i> Chính xác!';
            resultMessage.textContent = "Tuyệt vời! Bạn đã trả lời đúng.";
          } else {
            resultAlert.className = "alert alert-danger text-center";
            resultTitle.innerHTML =
              '<i class="fas fa-times-circle me-2"></i> Sai rồi!';
            resultMessage.innerHTML =
              "Đáp án đúng là: <strong>" + data.correct_word + "</strong>";
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-check me-2"></i> Kiểm tra';
          alert("Có lỗi xảy ra. Vui lòng thử lại.");
        });
    });

    // Next question
    nextBtn.addEventListener("click", function () {
      const topicId = document.getElementById("topicId").value;
      window.location.href = "/study/" + topicId + "/";
    });

    // Remove invalid class on input
    answerInput.addEventListener("input", function () {
      this.classList.remove("is-invalid");
    });
  });
</script>
{% endblock %}
